<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/plantas.css">

    <!-- Alterei aqui (Luis) -->
    <!-- script do google charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="funcoes.js"></script>

    <!-- scripts do Chart.js -->
    <script type="text/javascript" src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>
    <script type="text/javascript" src="https://www.chartjs.org/samples/latest/utils.js"></script>
    <script type="text/javascript" src="funcoes.js"></script>
    <!-- Alterei aqui (Luis) -->

    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
    <script type="text/javascript" src="funcoes.js"></script>

    <title>Plantas</title>
</head>

<body>
    <div id="pagplantas">
        <div class="menu">
            <a href="dashboard.html">
                <img class="logo" src="img/logo.png">
            </a>
            <a href="dashboard.html">
                <div class="div_graf">
                    <img class="icone_grafico" src="img/analytics.png" alt="">
                    <p style="margin-top: 8%;">Analytics</p>
                </div>
            </a>
            <a href="formulario2.html">
                <div class="div_supor">
                    <img class="icon_supor" src="img/fone-de-ouvido (1).png">
                    <p style="margin-top: 0;">Suporte</p>
                </div>
            </a>
            <div class="div_config">
                <img class="icone_config" src="img/config.png" alt="">
                <p style="margin-top: 4%;">Configura√ß√£o</p>
            </div>
            <a href="plantas.html">
                <div class="salas">
                    <img class="icon_planos" src="img/planos.png" alt="">
                    <p style="margin-top: 5%;">Plantas</p>
                </div>
            </a>
        </div>

        <div class="container">
            <!-- PARTE DO USUARIO -->
            <div id="usuario">
                <div id="nome_user">
                    <h2>
                        Ol√°, <b id="b_usuario"></b>
                    </h2>
                </div>
                <div id="nome_company">
                    ‚ö° <b id="b_empresa"></b> ‚ö°
                    <div id="sair">
                        <a href="login.html">
                            <img src="img/sair_icon.png" alt="">
                        </a>
                    </div>
                </div>

            </div>
            <div class="box">
                <div id="divisaobox">
                    <!-- SAUDA√á√ÉO -->
                    <div id="saudacao">
                        <h2>SEJA BEM VINDO üí°</h2>
                    </div>
                    <!-- DIVISOES DAS SALAS -->
                    <div id="salas">
                        <div id="onde">
                            <h2>VOC√ä EST√Å NO ANDAR <b id="local"></b></h2>
                        </div>
                        <div id="divsalas">
                            <div id="box_salas" onclick="Alterar(this)">A1</div>
                            <div id="box_salas" onclick="Alterar(this)">C2</div>
                            <div id="box_salas" onclick="Alterar(this)">B3</div>
                        </div>
                    </div>
                    <!-- PLANTAS -->
                    <div id="plantas">
                        <div id="divisao1">
                            <div id="imagemplanta">
                                <div id="quadro">
                                    <div id="valores">A</div>
                                    <div id="valores">B</div>
                                    <div id="valores">C</div>
                                    <div id="valores">D</div>
                                </div>
                            </div>
                        </div>
                        <div id="divisao2">
                            <div id="box1">
                                <div id="luz">
                                    <img id="imagemdaluz" src="img/lampadash.png" alt="">
                                </div>
                            </div>
                            <div id="butaografico">
                                <button id="btngrafic" onclick="visualizar()">Gr√°fico</button>
                                <button id="btnvoltar" onclick="voltar()">Voltar</button>
                            </div>
                            <div id="box2">
                                <div class="porcentagens">
                                    <h2>A</h2>
                                    <span id="s_leitura">
                                        <b id="b_leitura">?</b>%
                                    </span>
                                </div>
                                <div class="porcentagens">
                                    <h2>B</h2>
                                    <span id="s_leitura2">
                                        <b id="b_leitura2">?</b>%
                                    </span>
                                </div>
                                <div class="porcentagens">
                                    <h2>C</h2>
                                    <span id="s_leitura3">
                                        <b id="b_leitura3">?</b>%
                                    </span>
                                </div>
                                <div class="porcentagens">
                                    <h2>D</h2>
                                    <span class="cemporcento">
                                        <b id="b_leitura4">?</b>%
                                    </span>
                                </div>
                            </div>
                            <div id="graficochart">
                                <div id="boxgraficos">
                                    <div id="div_grafico_canvas">
                                        <section style="width:100%">
                                            <canvas id="canvas_grafico"></canvas>
                                            <section>
                                    </div>
                                </div>
                            </div>
                            <div id="mensagem">

                            </div>
                        </div>
                    </div>
                    <div id="numeros">
                        <div class="divisao_num" id="1" onclick="myFunction(this)">1</div>
                        <div class="divisao_num" id="2" onclick="myFunction(this)">2</div>
                        <div class="divisao_num" id="3" onclick="myFunction(this)">3</div>
                        <div class="divisao_num" id="4" onclick="myFunction(this)">4</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
<script>
    function myFunction(div) {
        var sala = div.id;
        saudacao.style = `display:none`;
        salas.style = `display:block`;
        plantas.style = `display:none`;
        local.innerHTML = `${sala}`;
    }
    function Alterar(div) {
        salas.style = `display:none`;
        plantas.style = `display:block`;

    }

    var limiteMax = 45;
    var limiteMin = 35;

    var limiteMax2 = 55;
    var limiteMin2 = 45;

    var limiteMax3 = 65;
    var limiteMin3 = 60;

    var limiteMax4 = 85;
    var limiteMin4 = 70;

    function receberNovasLeituras() {
        setTimeout(() => {

            luminosidade = (Math.random() * (limiteMax - limiteMin) + limiteMin).toFixed(1);
            luminosidade2 = (Math.random() * (limiteMax2 - limiteMin2) + limiteMin2).toFixed(1);
            luminosidade3 = (Math.random() * (limiteMax3 - limiteMin3) + limiteMin3).toFixed(1);
            luminosidade4 = (Math.random() * (limiteMax4 - limiteMin4) + limiteMin4).toFixed(1);


            // calculo de uma posi√ß√£o de 0 a 100% "entre" os limites min e max
            var posicao = (luminosidade - limiteMin) / (limiteMax - limiteMin) * 100;
            var posicao2 = (luminosidade2 - limiteMin2) / (limiteMax2 - limiteMin2) * 100;
            var posicao3 = (luminosidade3 - limiteMin3) / (limiteMax3 - limiteMin3) * 100;
            var posicao4 = (luminosidade4 - limiteMin4) / (limiteMax4 - limiteMin4) * 100;


            // temp est√° "baixa" (<25), "ok" (>=25 && <=75) ou "ok" (>75) ?
            // trocando a imagem e o estilo do valor da leitura
            if (posicao <= 40) {
                luz.style.background = "rgb(47, 67, 134)";
                mensagem.innerHTML = `Luz abaixo do ideal! O sistema aumentar√° automaticamente!`
            } else {
                luz.style.background = "#fba300";
                mensagem.innerHTML = `Luz est√° no ideal!`;
            }


            // atualizando o valor da leitura na p√°gina
            b_leitura.innerHTML = luminosidade;
            b_leitura2.innerHTML = luminosidade2;
            b_leitura3.innerHTML = luminosidade3;
            b_leitura4.innerHTML = luminosidade4;


            // fun√ß√£o que agenda a recupera√ß√£o da √∫ltima leitura para daqui a 3 segundos
            receberNovasLeituras();

        }, 2000); // 3000 ms -> 3 segundos
    }
    // indicando que a fun√ß√£o "receberNovasLeituras" ser√° invocada assim que a p√°gina carrega
    window.onload = receberNovasLeituras();
    verificar_autenticacao();

</script>

<!--imagem da lampada pra trocar de cores
https://www.flaticon.com/br/icone-gratis/lampada_702797?term=light&page=1&position=3&related_item_id=702797 -->
<script>
    (function (o, c, t, a, d, e, s, k) {
        o.octadesk = o.octadesk || {};
        s = c.getElementsByTagName("body")[0];
        k = c.createElement("script");
        k.async = 1;
        k.src = t + '/' + a + '?showButton=' + d + '&openOnMessage=' + e;
        s.appendChild(k);
    })(window, document, 'https://chat.octadesk.services/api/widget', 'phos4', true, true);
</script>

<script>
    
    //AQUI COME√áA PLOTAR GRAFICO

    let proximaAtualizacao;

        window.onload = obterDadosGraficoPrimeiraVez(1);


        function chamargraficos(idsensor) {

            obterDadosGraficoPrimeiraVez(idsensor)
            atualizarGrafico(idsensor)

        }

        verificar_autenticacao();

        // neste JSON tem que ser 'labels', 'datasets' etc, 
        // porque √© o padr√£o do Chart.js



        // altere aqui as configura√ß√µes do gr√°fico
        // (tamanhos, cores, textos, etc)
        function configurarGrafico() {
            var configuracoes = {
                responsive: true,
                animation: { duration: 500 },
                hoverMode: 'index',
                stacked: false,
                title: {
                    display: true,
                    text: 'Hist√≥rico recente de temperatura e umidade'
                },
                scales: {
                    yAxes: [{
                        type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                        display: true,
                        position: 'left',
                        id: 'y-temperatura',

                        gridLines: {
                            drawOnChartArea: false, // only want the grid lines for one axis to show up
                        },
                    }],
                }
            };

            return configuracoes;
        }

        // altere aqui como os dados ser√£o exibidos
        // e como s√£o recuperados do BackEnd
        function obterDadosGraficoPrimeiraVez(idsensor) {

            if (proximaAtualizacao != undefined) {
                clearTimeout(proximaAtualizacao);
            }

            fetch(`/leituras/ultimas/${idsensor}`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        resposta.reverse();

                        var dados = {
                            labels: [],
                            datasets: [
                                {
                                    yAxisID: 'y-temperatura',
                                    label: 'Lux',
                                    borderColor: window.chartColors.yellow,
                                    backgroundColor: window.chartColors.grey,
                                    fill: false,
                                    data: []
                                }
                            ]
                        };
                        for (i = 0; i < resposta.length; i++) {
                            var registro = resposta[i];
                            dados.labels.push(registro.momento_grafico);
                            dados.datasets[0].data.push(registro.lux);
                            // dados.datasets[1].data.push(registro.luminosidade);

                        }
                        console.log(JSON.stringify(dados));
                        plotarGrafico(dados, idsensor);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
                .catch(function (error) {
                    console.error(`Erro na obten√ß√£o dos dados p/ gr√°fico: ${error.message}`);
                });

        }



        // s√≥ mexer se quiser alterar o tempo de atualiza√ß√£o
        // ou se souber o que est√° fazendo!
        function atualizarGrafico(idsensor, dados) {

            fetch(`/leituras/tempo-real/${idsensor}`, { cache: 'no-store' }).then(function (response) {
                console.log("Estou tentando pegar idsensor = ", idsensor)
                if (response.ok) {
                    response.json().then(function (novoRegistro) {

                        console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                        console.log(`Dados atuais do gr√°fico: ${dados}`);

                        // tirando e colocando valores no gr√°fico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro.momento_grafico); // incluir um novo momento
                        dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
                        // dados.datasets[1].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro.lux); // incluir uma nova leitura de temperatura
                        // dados.datasets[1].data.push(novoRegistro.luminosidade); // incluir uma nova leitura de umidade

                        console.log("meu Lux √© o " + idsensor)

                        window.grafico_linha.update();


                        proximaAtualizacao = setTimeout(() => atualizarGrafico(idsensor, dados), 5000);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idsensor, dados), 5000);
                }
            })
                .catch(function (error) {
                    console.error(`Erro na obten√ß√£o dos dados p/ gr√°fico: ${error.message}`);
                });

        }

        // s√≥ altere aqui se souber o que est√° fazendo!
        function plotarGrafico(dados, idsensor) {
            console.log('iniciando plotagem do gr√°fico...');

            var ctx = canvas_grafico.getContext('2d');
            window.grafico_linha = Chart.Line(ctx, {
                data: dados,
                options: configurarGrafico()
            });

            setTimeout(() => atualizarGrafico(idsensor, dados), 5000);
        }


// function sendData() {
//     var http = new XMLHttpRequest();
//     http.open('GET', 'http://localhost:9000/api/sendData', false);
//     http.send(null);
// }

// setInterval(() => {
//     sendData();
// }, 2000);

</script>

<script>
    function visualizar() {
       graficochart.style = `display: block`;
       btnvoltar.style = `display: block`;
       box2.style = `display: none`;
       btngrafic.style = `display: none`;
       mensagem.style = `display: none`;

    }
    function voltar() {
        graficochart.style = `display: none`;
        btnvoltar.style = `display: none`;
        box2.style = `display: block`;
        box2.style = `display: flex`;
        btngrafic.style = `display: block`;
        mensagem.style = `display: block`;
    }
</script>